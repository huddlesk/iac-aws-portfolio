configure:
  stage: configure
  environment: $[[ inputs.environment ]]
  when: manual
  variables:
    ANSIBLE_HOST_KEY_CHECKING: "False"
  script:
    # Download and set up the secure files installer, which retrieves the SSH private key for Ansible to connect to the provisioned hosts
    - curl --silent "https://gitlab.com/gitlab-org/incubation-engineering/mobile-devops/download-secure-files/-/raw/main/installer" | sh
    # Set SSH key permissions and move it to the correct location for Ansible
    - mkdir ~/.ssh && chmod 700 ~/.ssh && mv $CI_PROJECT_DIR/.secure_files/id_ed25519_npp ~/.ssh/id_ed25519 && chmod 600 ~/.ssh/id_ed25519
    - cd ansible
    - ansible-playbook -i inventory-$[[ inputs.environment ]].ini site.yml
  needs:
    - provision
