# ============================================================================
# GitLab CI/CD Child Pipeline: Build, Lint, Provision, Configure
# ============================================================================
# This child pipeline is triggered by the parent pipeline (.gitlab-ci.yml)
# and executes the actual infrastructure deployment workflow.
#
# STAGES:
#   1. build_runner: Build and push Docker image to Docker Hub (on tags only)
#   2. lint-and-plan: Lint Ansible playbooks and generate Terraform plan
#   3. provision: Apply Terraform plan to provision infrastructure
#   4. configure: Execute Ansible playbooks to configure resources
# ============================================================================

spec:
  inputs:
    # Environment input passed from parent pipeline
    environment:
      type: string
      options: ["dev", "prod"]
      default: "dev" 
      description: "Select the target deployment environment"
---

stages:
  - build_runner      # Docker image build and push stage
  - lint-and-plan     # Code validation and infrastructure planning
  - provision         # Infrastructure provisioning with Terraform
  - configure         # Post-deployment configuration with Ansible

# Default configuration applied to all jobs
default:
  before_script:
    # Print versions for debugging and verification
    - echo "=== Pipeline Environment ==="
    - echo "uv $(uv self version)"
    - echo "Ansible $(ansible --version | head -1)"
    - echo "Terraform $(terraform --version | head -1)"
    - echo "Git $(git --version)"
    - echo "=== Configuration ==="
    - 'echo "Target Environment: $[[ inputs.environment ]]"'
    - export LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "(no tags)")
    - 'echo "Latest Git Tag: $LATEST_TAG"'
    - 'echo "Current Commit Tag: $CI_COMMIT_TAG"'

# ============================================================================
# STAGE: build_runner - Build Docker Image
# ============================================================================
# Builds and pushes the custom Docker image to Docker Hub.
# This image contains Ansible, Terraform, uv, and other required tools.
# Only runs when a commit is tagged (e.g., releases).

build_deploy_runner_image:
  stage: build_runner
  image: docker:20.10.16  # Use Docker-in-Docker image
  
  variables:
    DOCKER_IMAGE_NAME: huddlesk/uv-ansible-terraform-alpine
    BASE_DOCKER_IMAGE_TAG: 0-10.2-2.1-14.2  # Base image version
  
  services:
    # Enable Docker daemon for building images
    - docker:20.10.16-dind
  
  before_script:
    # Setup: Install git and authenticate with Docker Hub
    - apk add --no-cache git
    - echo "$DOCKERHUB_TOKEN" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
    
    # Determine image tag (use commit tag if available, otherwise latest git tag)
    - |
      if [ -n "$CI_COMMIT_TAG" ]; then
        echo "Building image for release: $CI_COMMIT_TAG"
        export LATEST_TAG="$CI_COMMIT_TAG"
      else
        export LATEST_TAG=$(git describe --tags --abbrev=0)
        echo "Building image for tag: $LATEST_TAG"
      fi
  
  script:
    # Verify Docker installation
    - docker version
    
    # Build Docker image from Dockerfile
    - 'echo "Building image: $DOCKER_IMAGE_NAME:$LATEST_TAG"'
    - docker build -t $DOCKER_IMAGE_NAME:$LATEST_TAG .
    
    # Push image to Docker Hub
    - 'echo "Pushing image: $DOCKER_IMAGE_NAME:$LATEST_TAG"'
    - docker push $DOCKER_IMAGE_NAME:$LATEST_TAG
  
  rules:
    # Only run when commit is tagged (release criteria)
    - if: '$CI_COMMIT_TAG != null'
    # Alternative triggers (commented out for reference):
    # - if: $CI_PIPELINE_SOURCE == "web"  # Manual trigger
    # - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH  # On main branch push

# ============================================================================
# STAGE: lint-and-plan - Validate Code and Plan Infrastructure
# ============================================================================
# Validates Ansible playbooks with ansible-lint and generates a Terraform
# execution plan to preview infrastructure changes without applying them.
# The plan is saved as an artifact for the provision stage.

lint_and_plan:
  stage: lint-and-plan
  environment: $[[ inputs.environment ]]
  
  variables:
    # Pass environment to Terraform as a variable
    TF_VAR_env: "$[[ inputs.environment ]]"
    # Configure Terraform provider caching for faster builds
    TF_PLUGIN_CACHE_DIR: "${CI_PROJECT_DIR}/.terraform-provider-cache"
  
  cache:
    key:
      # Invalidate cache when dependency lockfiles change
      files:
        - terraform/environments/$[[ inputs.environment ]]/.terraform.lock.hcl
        - .terraform.lock.hcl
    paths:
      # Cache Terraform plugins and providers to speed up future runs
      - terraform/environments/$[[ inputs.environment ]]/.terraform/
      - .terraform-provider-cache/
    # Pull cache before job, save after job
    policy: pull-push
  
  before_script:
    # Create cache directory for Terraform plugins
    - mkdir -p .terraform-provider-cache
  
  script:
    # Enable fail-on-pipe for better error detection
    - set -o pipefail
    
    # ANSIBLE LINTING: Validate playbook syntax and best practices
    - echo "=== Running Ansible Lint ==="
    - cd ansible
    - ansible-lint site.yml | tee ansible-lint.txt
    - cd ../
    
    # TERRAFORM PLANNING: Preview infrastructure changes
    - echo "=== Initializing Terraform ==="
    - cd terraform/environments/$[[ inputs.environment ]]
    - terraform init
    
    - echo "=== Creating Terraform Plan ==="
    - terraform plan -out=tfplan
  
  artifacts:
    paths:
      # Save lint report for review and debugging
      - ansible/ansible-lint.txt
      # Save plan for provision stage (must apply the same plan)
      - terraform/environments/$[[ inputs.environment ]]/tfplan
    
    # Keep artifacts for 3 days
    expire_in: "3 days"
    # Save artifacts even if job fails (for debugging)
    when: always

# ============================================================================
# STAGE: provision - Apply Infrastructure Changes
# ============================================================================
# Applies the Terraform plan generated in the lint-and-plan stage.
# This job is manually triggered to prevent accidental deployments.
# It applies the exact plan that was reviewed, without generating a new one.

provision:
  stage: provision
  environment: $[[ inputs.environment ]]
  
  # Require manual approval before deploying infrastructure
  when: manual
  
  script:
    # Navigate to environment-specific Terraform configuration
    - cd terraform/environments/$[[ inputs.environment ]]
    
    # Initialize Terraform with backend configuration
    - echo "=== Initializing Terraform ==="
    - terraform init
    
    # Apply the pre-generated plan (no new plan generation)
    # Using the saved tfplan ensures we deploy exactly what was reviewed
    - echo "=== Applying Terraform Plan ==="
    - terraform apply -auto-approve tfplan
  
  # Dependency on lint_and_plan to ensure plan artifact is available
  needs:
    - lint_and_plan

# ============================================================================
# STAGE: configure - Configure Infrastructure with Ansible
# ============================================================================
# Executes Ansible playbooks to configure the provisioned infrastructure.
# This stage runs after successful provisioning and is manually triggered.
# Requires the Ansible control machine (CI runner) to connect via SSH to
# the provisioned hosts. SSH key is retrieved from GitLab Secure Files.

configure:
  stage: configure
  environment: $[[ inputs.environment ]]
  
  # Require manual approval to prevent unintended configuration changes
  when: manual
  
  variables:
    # Disable SSH host key checking (secure for CI, as we control the hosts)
    ANSIBLE_HOST_KEY_CHECKING: "False"
  
  script:
    # SETUP: Download and retrieve SSH private key from GitLab Secure Files
    - echo "=== Setting up SSH Key ==="
    - curl --silent "https://gitlab.com/gitlab-org/incubation-engineering/mobile-devops/download-secure-files/-/raw/main/installer" | sh
    
    # Configure SSH directory with proper permissions (required by SSH)
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    
    # Move SSH key from secure files to standard location and set restrictive permissions
    - mv $CI_PROJECT_DIR/.secure_files/id_ed25519_npp ~/.ssh/id_ed25519
    - chmod 600 ~/.ssh/id_ed25519
    
    # EXECUTE: Run Ansible playbooks for configuration
    - echo "=== Running Ansible Playbooks ==="
    - cd ansible
    - ansible-playbook -i inventory-$[[ inputs.environment ]].ini site.yml
  
  # Dependency on provision job to ensure infrastructure is deployed first
  needs:
    - provision
