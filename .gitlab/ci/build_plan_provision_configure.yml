spec:
  inputs:
    environment: # Provide this on job run from the GitLab UI
      type: string
      options: ["dev", "prod"]
      default: "dev" 
      description: "Select the environment to deploy to"
---
stages:
  - build_runner
  - lint-and-plan # Ansible linting and Terraform planning stage
  - provision # Terraform apply stage
  - configure # Ansible playbook execution stage

default:
  before_script: # Optional: Print versions for debugging
  - echo "$(uv self version)"
  - echo "$(ansible --version)"
  - echo "$(terraform --version)"
  - echo "Selected environment $[[ inputs.environment ]]"
  - echo "Latest tag $(git describe --tags --abbrev=0)"
  - echo "Commit Tag $CI_COMMIT_TAG"

build_deploy_runner_image:
  stage: build_runner
  image: docker:20.10.16
  variables:
    DOCKER_IMAGE_NAME: huddlesk/uv-ansible-terraform-alpine
    BASE_DOCKER_IMAGE_TAG: 0-10.2-2.1-14.2
  #when: manual
  services:
    - docker:20.10.16-dind
  before_script:
    - apk add --no-cache git
    - echo "$DOCKERHUB_TOKEN" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
    - if [ -n "$CI_COMMIT_TAG" ]; then
        echo "Build for $CI_COMMIT_TAG";
        export LATEST_TAG="$CI_COMMIT_TAG";
      else
        export LATEST_TAG=$(git describe --tags --abbrev=0);
        echo "Build for $LATEST_TAG";
      fi
  script:
    - docker version
    - docker build -t $DOCKER_IMAGE_NAME:$LATEST_TAG .
    - docker push $DOCKER_IMAGE_NAME:$LATEST_TAG
  rules:
    - if: '$CI_COMMIT_TAG != null'
    #- if: $CI_PIPELINE_SOURCE == "web"
    #- if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH  # Enables a pipelines on main

lint_and_plan:
  stage: lint-and-plan
  #when: manual
  environment: $[[ inputs.environment ]]
  variables:
    TF_VAR_env: "$[[ inputs.environment ]]"
    TF_PLUGIN_CACHE_DIR: "${CI_PROJECT_DIR}/.terraform-provider-cache"  # Global cache
  cache:
    key:
      files: # Cache based on lockfiles to ensure updates are captured
        - terraform/environments/$[[ inputs.environment ]]/.terraform.lock.hcl  # Per-env lockfile
        - .terraform.lock.hcl  # Or global
    paths: # Cache plugins and providers to speed up subsequent runs
      - terraform/environments/$[[ inputs.environment ]]/.terraform/  # Local providers/modules
      - .terraform-provider-cache/  # Plugin cache
    policy: pull-push  # Reuse + save
  before_script:  # Optional: mkdir if needed
    - mkdir -p .terraform-provider-cache
  script:
    - set -o pipefail
    - cd ansible
    - ansible-lint site.yml | tee ansible-lint.txt
    - cd ../terraform/environments/$[[ inputs.environment ]]
    - terraform init
    - terraform plan -out=tfplan
  artifacts:
    paths: # Save lint results and Terraform plan for review and later stages
      - ansible/ansible-lint.txt
      - terraform/environments/$[[ inputs.environment ]]/tfplan
    untracked: false
    when: always # Always save artifacts, even if the job fails, for debugging
    expire_in: "3 days"

provision:
  stage: provision
  environment: $[[ inputs.environment ]]
  when: manual
  script:
    - cd terraform/environments/$[[ inputs.environment ]]
    - terraform init
    - terraform apply -auto-approve tfplan
  needs:
    - lint_and_plan

configure:
  stage: configure
  environment: $[[ inputs.environment ]]
  when: manual
  variables:
    ANSIBLE_HOST_KEY_CHECKING: "False"
  script:
    # Download and set up the secure files installer, which retrieves the SSH private key for Ansible to connect to the provisioned hosts
    - curl --silent "https://gitlab.com/gitlab-org/incubation-engineering/mobile-devops/download-secure-files/-/raw/main/installer" | sh
    # Set SSH key permissions and move it to the correct location for Ansible
    - mkdir ~/.ssh && chmod 700 ~/.ssh && mv $CI_PROJECT_DIR/.secure_files/id_ed25519_npp ~/.ssh/id_ed25519 && chmod 600 ~/.ssh/id_ed25519
    - cd ansible
    - ansible-playbook -i inventory-$[[ inputs.environment ]].ini site.yml
  needs:
    - provision
