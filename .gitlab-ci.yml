# ============================================================================
# GitLab CI/CD Pipeline: Infrastructure as Code (IaC) with Ansible & Terraform
# ============================================================================
#
# PURPOSE:
#   This pipeline automates the complete lifecycle of infrastructure provisioning
#   and configuration using Infrastructure-as-Code principles. It validates,
#   deploys, and configures infrastructure changes across multiple environments.
#
# ARCHITECTURE:
#   This is a parent pipeline (.gitlab-ci.yml) that controls the overall workflow
#   and triggers a child pipeline (.gitlab/ci/build_plan_provision_configure.yml)
#   with the appropriate environment configuration.
#
# PIPELINE STAGES:
#   1. .pre (generate-config):
#      - Checks if the current commit is tagged
#      - Skips redundant pipelines when HEAD matches the latest tag
#      - Generates dynamic configuration with Docker image tag
#   
#   2. trigger_child_pipeline (trigger-child):
#      - Triggers the child pipeline with environment input
#      - Waits for child pipeline completion before finishing
#      - Passes generated configuration to child pipeline
#
# DOCKER IMAGE:
#   Custom image: huddlesk/uv-ansible-terraform-alpine
#   Includes: uv (Python package manager), Ansible, Terraform, Git
#   Image tag format: MAJOR-UV_VERSION-ANSIBLE_VERSION-TERRAFORM_VERSION
#   Built from: Dockerfile (see project root)
#
# TRIGGERS & EXECUTION:
#   - Manual trigger via GitLab UI
#   - Scheduled pipelines (set via GitLab UI)
#   - Automatic on commits to default branch (main)
#   - Automatic on tagged commits (for releases)
#
# INPUT VARIABLES:
#   environment: Select deployment target (dev, prod) via GitLab UI
#
# SECURITY:
#   - SSH keys managed via GitLab Secure Files
#   - Docker Hub credentials via CI/CD variables
#   - No hardcoded credentials in pipeline
#
# See docs/README-GitLab.md for detailed documentation
spec:
  inputs:
    # Environment input variable for multi-environment support
    environment:
      type: string
      options: ["dev", "prod"]
      default: "dev" 
      description: "Select the target deployment environment (dev or prod)"
---

# Workflow rules: Control when the pipeline executes
workflow:
  rules:
    - if: $CI_PIPELINE_SOURCE == "web"  # Manual trigger from GitLab UI
    - if: $CI_PIPELINE_SOURCE == "schedule"  # Scheduled pipeline execution
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH  # Push to default branch (main)
    - if: $CI_COMMIT_TAG != null  # Tag creation (e.g., release tags)
    
stages:
  - .pre              # Pre-processing: generate dynamic configuration
  - trigger_child_pipeline  # Trigger child pipeline with environment config

# ============================================================================
# STAGE: .pre - Configuration Generation
# ============================================================================
# This job generates the dynamic pipeline configuration with the Docker image
# tag that includes version information. It also prevents redundant pipeline
# runs when the commit is already tagged.

generate-config:
  stage: .pre
  before_script:
    # Fetch all tags to ensure we have the latest version information
    - git fetch --tags --prune-tags
  
  script:
    # Determine the latest tag (for Docker image versioning)
    - 'echo "Checking commit: $CI_COMMIT_SHA"'
    - export LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "")

    - 'echo "image: huddlesk/uv-ansible-terraform-alpine:$LATEST_TAG"'
    - 'echo "image: huddlesk/uv-ansible-terraform-alpine:$LATEST_TAG" > generated-config.yml'
    - 'echo "Commit Tag: $CI_COMMIT_TAG"'
    - 'echo "Latest Tag: $LATEST_TAG"'

    # Skip redundancy check if not on main branch (allow other branch pipelines)
    - |
      if [ "$CI_COMMIT_BRANCH" != "main" ]; then
        echo "Branch: $CI_COMMIT_BRANCH (not main). Skipping tag redundancy check."
        exit 0
      fi
    
    # Skip if no tags exist yet (first deployment)
    - |
      if [ -z "$LATEST_TAG" ]; then
        echo "No tags found. Proceeding with first deployment."
        exit 0
      fi
    
    # Check if current commit is already tagged (prevent redundant deploys)
    - TAG_SHA=$(git rev-parse "$LATEST_TAG")
    - 'echo "Latest tag $LATEST_TAG points to commit: $TAG_SHA"'

    - |
      if [ "$TAG_SHA" = "$CI_COMMIT_SHA" ]; then
        echo "ERROR: Current commit ($CI_COMMIT_SHA) is already at the latest tag ($LATEST_TAG)."
        echo "Skipping redundant pipeline run."
        exit 1
      else
        echo "Commit is ahead of tags. Proceeding with pipeline."
        exit 0
      fi
  
  allow_failure: false
  
  artifacts:
    paths:
      - generated-config.yml  # Configuration file with Docker image tag


# ============================================================================
# STAGE: trigger_child_pipeline - Execute Infrastructure Pipeline
# ============================================================================
# This job triggers the child pipeline which handles building the Docker image,
# linting code, planning infrastructure changes, provisioning resources, and
# configuring them with Ansible.

trigger-child:
  stage: trigger_child_pipeline
  
  trigger:
    # Include configuration from child pipeline and generated config
    include:
      # Child pipeline definition with stage definitions and jobs
      - local: .gitlab/ci/build_plan_provision_configure.yml  
        inputs:
          environment: $[[ inputs.environment ]]  # Pass environment to child pipeline
      
      # Generated configuration with Docker image tag
      - artifact: generated-config.yml
        job: generate-config 
    
    # Wait for child pipeline to complete before marking parent as done
    strategy: depend
  
  # Ensure generated-config job completes first and artifacts are available
  needs:
    - job: generate-config
      artifacts: true
